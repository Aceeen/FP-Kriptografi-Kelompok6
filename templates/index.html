<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Integrity Checker</title>
    <!-- Menghubungkan ke Google Fonts untuk font Inter dan Source Code Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Source+Code+Pro&display=swap" rel="stylesheet">
    <!-- Menghubungkan ke CSS Eksternal menggunakan url_for dari Flask -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>File Integrity Checker</h1>
        <p>Demonstrasi penggunaan fungsi hash (SHA-256) untuk verifikasi integritas file.</p>

        <h2>Files on Server</h2>
        <button class="btn btn-secondary" onclick="fetchFiles()">Refresh File List</button>
        <table id="filesTable">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>SHA-256 Hash (Server)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="3">Loading...</td></tr>
            </tbody>
        </table>


        <h2>Verify Downloaded File</h2>
        <div class="card">
            <p>
                Pilih file dari komputer Anda yang namanya <strong>sama</strong> dengan salah satu file di server
                untuk memverifikasi integritasnya.
            </p>
            <label for="fileInput" class="file-input-label">Pilih file lokal:</label>
            <input type="file" id="fileInput" style="margin-bottom: 15px;">
            <br>
            <button class="btn btn-primary" onclick="verifyFile()">Verify Selected File</button>
        </div>

        <!-- Area hasil verifikasi -->
        <div id="verificationResult" class="alert"></div>
    </div>

    <script>
        const API_BASE_URL = "";
        let serverFilesCache = [];

        // Fungsi untuk menampilkan pesan status
        function showStatus(message, type = 'info') {
            const resultDiv = document.getElementById('verificationResult');
            resultDiv.innerHTML = message;
            resultDiv.className = `alert alert-${type}`;
            resultDiv.style.display = 'block'; // Tampilkan div
        }

        // Fungsi untuk menyembunyikan status
        function hideStatus() {
             const resultDiv = document.getElementById('verificationResult');
             resultDiv.style.display = 'none';
        }

        // Fungsi untuk memformat hash dalam HTML
        function formatHash(hash) {
             return `<span class="hash-value">${hash}</span>`;
        }

        async function fetchFiles() {
            const tableBody = document.querySelector("#filesTable tbody");
            tableBody.innerHTML = '<tr><td colspan="3">Loading file list from server...</td></tr>';
            hideStatus();
            serverFilesCache = [];

            try {
                const response = await fetch(`${API_BASE_URL}/files`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const files = await response.json();
                serverFilesCache = files;
                tableBody.innerHTML = '';

                if (files.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3">No files found in the server directory.</td></tr>';
                    return;
                }

                files.forEach(file => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = file.filename;

                    const hashCell = row.insertCell();
                    hashCell.innerHTML = formatHash(file.sha256_hash);

                    const actionsCell = row.insertCell();
                    // Gunakan tag <a> untuk download agar lebih natural
                    const downloadLink = document.createElement('a');
                    downloadLink.textContent = 'Download';
                    downloadLink.href = `${API_BASE_URL}/download/${file.filename}`;
                    downloadLink.className = 'btn btn-sm btn-primary';
                    actionsCell.appendChild(downloadLink);

                });
            } catch (error) {
                console.error('Error fetching files:', error);
                tableBody.innerHTML = `<tr><td colspan="3" style="color: #721c24;">Error loading files: ${error.message}</td></tr>`;
                showStatus(`Failed to fetch file list: ${error.message}`, 'danger');
            }
        }

        async function calculateSHA256FromFile(file) {
            // Menggunakan Web Crypto API untuk hashing di sisi klien
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            // Convert array byte ke string hex
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        async function verifyFile() {
            const fileInput = document.getElementById('fileInput');

            if (fileInput.files.length === 0) {
                showStatus('Please select a file to verify.', 'danger');
                return;
            }

            const localFile = fileInput.files[0];
            const localFileName = localFile.name;

            showStatus(`Verifying <strong>${localFileName}</strong>...`, 'info');

            // Cari hash yang diharapkan dari cache
            const serverFileMatch = serverFilesCache.find(sf => sf.filename === localFileName);

            let expectedHash;
            let statusMessage = "";

            if (serverFileMatch) {
                expectedHash = serverFileMatch.sha256_hash.toLowerCase();
                statusMessage += `Found matching file on server.<br>Expected hash (Server): ${formatHash(expectedHash)}`;
            } else {
                // Fallback: Coba ambil dari endpoint /hash
                statusMessage += `File not in cache. Fetching hash from server...<br>`;
                try {
                    const response = await fetch(`${API_BASE_URL}/hash/${localFileName}`);
                    if (!response.ok) {
                         if (response.status === 404) {
                             showStatus(`Error: File "${localFileName}" not found on server. Cannot verify.`, 'danger');
                             return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const hashData = await response.json();
                    expectedHash = hashData.sha256_hash.toLowerCase();
                    statusMessage += `Successfully fetched hash.<br>Expected hash (Server): ${formatHash(expectedHash)}`;
                } catch (error) {
                    showStatus(`Error: Could not retrieve hash for "${localFileName}" from server. ${error.message}`, 'danger');
                    return;
                }
            }

            showStatus(statusMessage + `<br>Calculating local file hash...`, 'info');

            try {
                const calculatedHash = await calculateSHA256FromFile(localFile);
                statusMessage += `<br>Calculated hash (Local): ${formatHash(calculatedHash)} <br><br>`;

                if (calculatedHash === expectedHash) {
                    showStatus(statusMessage + '<strong>[âœ“] VERIFICATION SUCCESSFUL: File integrity is intact.</strong>', 'success');
                } else {
                    showStatus(statusMessage + '<strong>[!] VERIFICATION FAILED: File may be corrupted or modified.</strong><br><small>Ensure the local file name exactly matches the server file and has not been altered.</small>', 'danger');
                }
            } catch (error) {
                console.error('Error verifying file:', error);
                showStatus(`Error during local hash calculation: ${error.message}`, 'danger');
            }
        }

        // Fetch files saat halaman dimuat
        window.onload = fetchFiles;
    </script>
</body>
</html>
